<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Ofícios</title>
    <!-- Estilos CSS simples para a interface -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .container {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-bottom: 20px;
        }

        h1, h2 {
            color: #2c3e50;
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* Seção do Formulário */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Garante que padding não aumente a largura */
            font-size: 1em;
            background-color: #fcfcfc;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        button.primary {
            background-color: #3498db;
            color: white;
        }

        button.primary:hover {
            background-color: #2980b9;
        }

        button.secondary {
            background-color: #95a5a6;
            color: white;
        }

        button.secondary:hover {
            background-color: #7f8c8d;
        }

        button.danger {
            background-color: #e74c3c;
            color: white;
        }

        button.danger:hover {
            background-color: #c0392b;
        }

        /* Seção da Tabela de Ofícios */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
            flex-wrap: wrap; /* Permite que os itens quebrem a linha */
        }

        .table-controls input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1; /* Permite que o campo de pesquisa cresça */
            min-width: 150px;
        }

        .table-responsive {
            overflow-x: auto; /* Permite rolagem horizontal em telas pequenas */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f8f8;
            color: #555;
            font-weight: bold;
            white-space: nowrap; /* Impede que o texto do cabeçalho quebre */
        }

        td {
            background-color: #fff;
            white-space: nowrap; /* Impede que o texto da célula quebre, pode ajustar se necessário */
        }

        tbody tr:hover {
            background-color: #f1f1f1;
        }

        .table-actions {
            display: flex;
            gap: 5px;
        }
        .table-actions button {
            padding: 6px 10px;
            font-size: 0.85em;
        }

        /* Feedback de Mensagens */
        #feedbackMessage {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            display: none; /* Escondido por padrão */
            font-weight: bold;
        }

        #feedbackMessage.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        #feedbackMessage.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Seção do Gráfico */
        .chart-container {
            width: 100%;
            max-width: 800px; /* Limita a largura do gráfico */
            margin: 20px auto; /* Centraliza o gráfico */
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        /* Indicador de carregamento */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none; /* Escondido por padrão */
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
    <!-- Overlay de Carregamento -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <h1>Controle de Ofícios</h1>

        <div id="feedbackMessage"></div>

        <h2>Formulário de Ofício</h2>
        <form id="oficioForm">
            <input type="hidden" id="idLinha" name="idLinha">
            <div class="form-grid">
                <div class="form-group">
                    <label for="numero">Número do Ofício:</label>
                    <input type="number" id="numero" name="numero" required min="1">
                </div>
                <div class="form-group">
                    <label for="data">Data:</label>
                    <input type="date" id="data" name="data" required>
                </div>
                <div class="form-group">
                    <label for="secretaria">Secretaria / Remetente:</label>
                    <select id="secretaria" name="secretaria">
                        <option value="">Selecione</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assunto">Assunto:</label>
                    <textarea id="assunto" name="assunto" required></textarea>
                </div>
                <div class="form-group">
                    <label for="situacao">Situação:</label>
                    <select id="situacao" name="situacao">
                        <option value="">Selecione</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="situacaoFinal">Situação Final / Destinatário:</label>
                    <select id="situacaoFinal" name="situacaoFinal">
                        <option value="">Selecione</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="categoria">Categoria:</label>
                    <select id="categoria" name="categoria">
                        <option value="">Selecione</option>
                    </select>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="primary">Salvar Ofício</button>
                <button type="button" class="secondary" id="btnLimparForm">Limpar Formulário</button>
            </div>
        </form>
    </div>

    <div class="container">
        <h2>Lista de Ofícios</h2>
        <div class="table-controls">
            <input type="text" id="searchInput" placeholder="Pesquisar por termo...">
            <button type="button" class="secondary" id="btnRecarregarTabela">Recarregar</button>
        </div>
        <div class="table-responsive">
            <table id="oficiosTable">
                <thead>
                    <tr>
                        <th>Número</th>
                        <th>Data</th>
                        <th>Secretaria</th>
                        <th>Assunto</th>
                        <th>Situação</th>
                        <th>Situação Final</th>
                        <th>Categoria</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Linhas dos ofícios serão inseridas aqui pelo JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="chart-container">
        <h2>Ofícios por Secretaria</h2>
        <canvas id="oficiosChart"></canvas>
    </div>

    <!-- Inclui a biblioteca Chart.js via CDN para os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // !! IMPORTANTE !! SUBSTITUA ESTE ENDEREÇO PELO URL DO SEU DEPLOYMENT DO APPS SCRIPT
        const API_URL = 'https://script.google.com/macros/s/AKfycby-fhUQBZLZo_IhWLt7ijsGWxp33pZggNC7zuhlO9bpNKcay0MHU0VqzVc6Qp5RNe1V/exec'; // Ex: 'https://script.google.com/macros/s/SEU_ID_DE_DEPLOYMENT/exec'

        // --- Elementos da UI ---
        const oficioForm = document.getElementById('oficioForm');
        const idLinhaInput = document.getElementById('idLinha');
        const numeroInput = document.getElementById('numero');
        const dataInput = document.getElementById('data');
        const secretariaSelect = document.getElementById('secretaria');
        const assuntoTextarea = document.getElementById('assunto');
        const situacaoSelect = document.getElementById('situacao');
        const situacaoFinalSelect = document.getElementById('situacaoFinal');
        const categoriaSelect = document.getElementById('categoria');
        const btnLimparForm = document.getElementById('btnLimparForm');
        const searchInput = document.getElementById('searchInput');
        const btnRecarregarTabela = document.getElementById('btnRecarregarTabela');
        const oficiosTableBody = document.querySelector('#oficiosTable tbody');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const oficiosChartCanvas = document.getElementById('oficiosChart');
        let myChart; // Variável para armazenar a instância do gráfico Chart.js

        // --- Funções Auxiliares ---

        /**
         * Exibe ou esconde o overlay de carregamento.
         * @param {boolean} show Se true, exibe; se false, esconde.
         */
        function toggleLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        /**
         * Exibe uma mensagem de feedback para o usuário.
         * @param {string} message A mensagem a ser exibida.
         * @param {string} type O tipo de mensagem ('success' ou 'error').
         */
        function showFeedback(message, type) {
            feedbackMessage.textContent = message;
            feedbackMessage.className = ''; // Limpa classes anteriores
            feedbackMessage.classList.add(type);
            feedbackMessage.style.display = 'block';
            setTimeout(() => {
                feedbackMessage.style.display = 'none';
            }, 5000); // Esconde a mensagem após 5 segundos
        }

        /**
         * Converte a data para o formato yyyy-MM-dd para inputs de data HTML.
         * @param {string} dateString A string de data no formato dd/MM/yyyy.
         * @returns {string} A data formatada para yyyy-MM-dd.
         */
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return dateString; // Retorna original se o formato não corresponder
        }

        /**
         * Converte a data para o formato dd/MM/yyyy para exibição na tabela.
         * @param {string} dateString A string de data no formato yyyy-MM-dd (do input) ou objeto Date.
         * @returns {string} A data formatada para dd/MM/yyyy.
         */
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            // Se já for dd/MM/yyyy, retorna. Se for yyyy-MM-dd (do input), converte.
            if (dateString.includes('/')) return dateString;

            const date = new Date(dateString + 'T00:00:00'); // Adiciona T00:00:00 para evitar problemas de fuso horário
            if (isNaN(date.getTime())) return dateString; // Se for inválido, retorna original

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Mês é base 0
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }


        /**
         * Preenche um elemento <select> com opções.
         * @param {HTMLSelectElement} selectElement O elemento select a ser preenchido.
         * @param {Array<string>} optionsArray Um array de strings com as opções.
         * @param {string} placeholder O texto da primeira opção (placeholder).
         */
        function populateSelect(selectElement, optionsArray, placeholder = 'Selecione') {
            selectElement.innerHTML = `<option value="">${placeholder}</option>`;
            optionsArray.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }

        /**
         * Limpa o formulário e gera um novo número de ofício.
         */
        async function clearForm() {
            oficioForm.reset();
            idLinhaInput.value = ''; // Limpa o ID da linha para indicar nova criação
            try {
                const data = await fetchData('getProximoNumeroOficio');
                // A API Apps Script retorna o número diretamente em caso de sucesso.
                // Se houver um erro, o fetchData lançará uma exceção.
                numeroInput.value = data; 
            } catch (error) {
                showFeedback(`Erro ao gerar próximo número: ${error.message}`, 'error');
            }
            // Define a data atual como padrão
            const today = new Date().toISOString().split('T')[0];
            dataInput.value = today;
            numeroInput.focus();
        }

        /**
         * Inicializa ou atualiza o gráfico Chart.js.
         * @param {Array<string>} labels Rótulos para o gráfico (e.g., nomes das secretarias).
         * @param {Array<number>} data Dados numéricos para o gráfico (e.g., contagens).
         */
        function updateChart(labels, data) {
            if (myChart) {
                myChart.destroy(); // Destrói a instância anterior do gráfico
            }
            myChart = new Chart(oficiosChartCanvas, {
                type: 'bar', // Pode ser 'pie', 'doughnut', 'line', etc.
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Número de Ofícios',
                        data: data,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)', // Cor azul
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0 // Garante que os ticks sejam números inteiros
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // Não exibe a legenda do dataset
                        },
                        title: {
                            display: true,
                            text: 'Contagem de Ofícios por Secretaria'
                        }
                    }
                }
            });
        }


        // --- Comunicação com a API (fetch) ---

        /**
         * Função genérica para fazer requisições GET ou POST para a API do Apps Script.
         * Lida com o formato de resposta JSON esperado (com 'success' e 'error' campos).
         * @param {string} action A ação a ser executada na API (e.g., 'listarOficios', 'salvarOficio').
         * @param {Object} [paramsOrData] Parâmetros para GET (objeto para URLSearchParams) ou dados para POST (objeto para JSON.stringify).
         * @param {string} method O método HTTP ('GET' ou 'POST').
         * @returns {Promise<Object>} Uma promessa que resolve com os dados da resposta da API (payload).
         * @throws {Error} Se a requisição falhar ou a API retornar um erro no payload JSON.
         */
        async function fetchData(action, paramsOrData = {}, method = 'GET') {
            toggleLoading(true); // Ativa o indicador de carregamento
            let url = API_URL;
            let options = { method: method };

            if (method === 'GET') {
                const urlParams = new URLSearchParams(paramsOrData).toString();
                // Adiciona 'action' como um parâmetro de URL
                url = `${API_URL}?action=${action}${urlParams ? '&' + urlParams : ''}`;
            } else if (method === 'POST') {
                options.headers = {
                    'Content-Type': 'application/json'
                };
                // Adiciona 'action' e os outros dados ao corpo JSON
                options.body = JSON.stringify({ action: action, ...paramsOrData });
            }

            try {
                const response = await fetch(url, options);
                const data = await response.json(); // Sempre tenta parsear como JSON

                // Verifica se o payload JSON indica um erro (conforme o Apps Script agora retorna)
                if (data.success === false) {
                    throw new Error(data.error || 'Erro desconhecido na API.');
                }
                // Para requisições GET, o Apps Script retorna o resultado diretamente.
                // Para requisições POST, ele retorna { success: true, message: "..." }.
                // Retornamos o 'data' completo para que o chamador possa acessar 'message' se for POST.
                return data; 
            } catch (error) {
                console.error('Erro ao comunicar com a API:', error);
                throw error; // Rejeita a promessa para ser capturada pelo bloco catch do chamador
            } finally {
                toggleLoading(false); // Desativa o indicador de carregamento
            }
        }

        // --- Funções de Carregamento de Dados ---

        /**
         * Carrega as opções dos dropdowns da API e preenche os selects.
         */
        async function loadDropdowns() {
            try {
                const data = await fetchData('getOpcoesDropdowns');
                populateSelect(secretariaSelect, data.secretarias, 'Selecione a Secretaria');
                populateSelect(situacaoSelect, data.situacoes, 'Selecione a Situação');
                populateSelect(situacaoFinalSelect, data.situacoesFinal, 'Selecione a Situação Final');
                populateSelect(categoriaSelect, data.categorias, 'Selecione a Categoria');
            } catch (error) {
                showFeedback(`Erro ao carregar opções de dropdown: ${error.message}`, 'error');
            }
        }

        /**
         * Carrega os dados dos ofícios da API e preenche a tabela.
         * @param {string} searchTerm Opcional. Termo de pesquisa para filtrar os ofícios.
         */
        async function loadOficios(searchTerm = '') {
            try {
                // A API retorna um array de ofícios diretamente no payload de sucesso.
                const oficios = await fetchData('listarOficios', { termoPesquisa: searchTerm });
                oficiosTableBody.innerHTML = ''; // Limpa a tabela antes de preencher

                if (oficios.length === 0) {
                    oficiosTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nenhum ofício encontrado.</td></tr>';
                    return;
                }

                oficios.forEach(oficio => {
                    const row = oficiosTableBody.insertRow();
                    row.insertCell().textContent = oficio.numero;
                    row.insertCell().textContent = oficio.data; // Já vem formatado dd/MM/yyyy
                    row.insertCell().textContent = oficio.secretaria;
                    row.insertCell().textContent = oficio.assunto;
                    row.insertCell().textContent = oficio.situacao;
                    row.insertCell().textContent = oficio.situacaoFinal;
                    row.insertCell().textContent = oficio.categoria;

                    const actionsCell = row.insertCell();
                    actionsCell.classList.add('table-actions');

                    const editButton = document.createElement('button');
                    editButton.textContent = 'Editar';
                    editButton.classList.add('secondary');
                    editButton.onclick = () => editOficio(oficio.idLinha);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Excluir';
                    deleteButton.classList.add('danger');
                    deleteButton.onclick = () => deleteOficio(oficio.idLinha);
                    actionsCell.appendChild(deleteButton);
                });
            } catch (error) {
                showFeedback(`Erro ao carregar ofícios: ${error.message}`, 'error');
            }
        }

        /**
         * Carrega os dados para o gráfico e o atualiza.
         */
        async function loadChartData() {
            try {
                // A API retorna um objeto { labels: [], data: [] } diretamente no payload de sucesso.
                const data = await fetchData('getDadosParaGrafico');
                updateChart(data.labels, data.data);
            } catch (error) {
                showFeedback(`Erro ao carregar dados do gráfico: ${error.message}`, 'error');
            }
        }

        // --- Event Handlers ---

        /**
         * Lida com o envio do formulário de ofício (salvar ou atualizar).
         */
        oficioForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Impede o recarregamento da página

            const oficio = {
                idLinha: idLinhaInput.value ? parseInt(idLinhaInput.value) : null,
                numero: numeroInput.value,
                data: dataInput.value, // Data já está no formato yyyy-MM-dd para a API
                secretaria: secretariaSelect.value,
                assunto: assuntoTextarea.value,
                situacao: situacaoSelect.value,
                situacaoFinal: situacaoFinalSelect.value,
                categoria: categoriaSelect.value
            };

            try {
                // A API POST retorna { success: true, message: "..." } no payload.
                const response = await fetchData('salvarOficio', { oficio: oficio }, 'POST');
                showFeedback(response.message, 'success');
                clearForm(); // Limpa o formulário após o sucesso
                loadOficios(searchInput.value); // Recarrega a tabela com o termo de pesquisa atual
                loadChartData(); // Atualiza o gráfico
            } catch (error) {
                showFeedback(`Erro ao salvar ofício: ${error.message}`, 'error');
            }
        });

        /**
         * Preenche o formulário com os dados de um ofício para edição.
         * @param {number} idLinha O ID da linha do ofício a ser editado.
         */
        async function editOficio(idLinha) {
            try {
                // A API retorna o objeto ofício diretamente no payload de sucesso.
                const oficio = await fetchData('getOficioById', { idLinha: idLinha });
                if (oficio) {
                    idLinhaInput.value = oficio.idLinha;
                    numeroInput.value = oficio.numero;
                    dataInput.value = oficio.data; // Já vem no formato yyyy-MM-dd
                    secretariaSelect.value = oficio.secretaria;
                    assuntoTextarea.value = oficio.assunto;
                    situacaoSelect.value = oficio.situacao;
                    situacaoFinalSelect.value = oficio.situacaoFinal;
                    categoriaSelect.value = oficio.categoria;
                    showFeedback('Ofício carregado para edição.', 'success');
                } else {
                    showFeedback('Ofício não encontrado para edição.', 'error');
                }
            } catch (error) {
                showFeedback(`Erro ao carregar ofício para edição: ${error.message}`, 'error');
            }
        }

        /**
         * Confirma e exclui um ofício.
         * @param {number} idLinha O ID da linha do ofício a ser excluído.
         */
        async function deleteOficio(idLinha) {
            if (confirm('Tem certeza que deseja excluir este ofício?')) {
                try {
                    // A API POST retorna { success: true, message: "..." } no payload.
                    const response = await fetchData('apagarOficio', { idLinha: idLinha }, 'POST');
                    showFeedback(response.message, 'success');
                    loadOficios(searchInput.value); // Recarrega a tabela
                    loadChartData(); // Atualiza o gráfico
                } catch (error) {
                    showFeedback(`Erro ao excluir ofício: ${error.message}`, 'error');
                }
            }
        }

        // Adiciona listeners para os botões e campo de pesquisa
        btnLimparForm.addEventListener('click', clearForm);
        btnRecarregarTabela.addEventListener('click', () => loadOficios(searchInput.value));
        searchInput.addEventListener('input', () => loadOficios(searchInput.value)); // Pesquisa em tempo real

        // --- Inicialização da Aplicação ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDropdowns();
            loadOficios();
            loadChartData();
            clearForm(); // Limpa o formulário e gera o próximo número na inicialização
        });

    </script>
</body>
</html>
